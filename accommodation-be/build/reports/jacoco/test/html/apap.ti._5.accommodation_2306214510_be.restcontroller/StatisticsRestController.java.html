<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StatisticsRestController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">accommodation-2306214510-be</a> &gt; <a href="index.source.html" class="el_package">apap.ti._5.accommodation_2306214510_be.restcontroller</a> &gt; <span class="el_source">StatisticsRestController.java</span></div><h1>StatisticsRestController.java</h1><pre class="source lang-java linenums">package apap.ti._5.accommodation_2306214510_be.restcontroller;

import apap.ti._5.accommodation_2306214510_be.dto.BaseResponseDTO;
import apap.ti._5.accommodation_2306214510_be.model.Property;
import apap.ti._5.accommodation_2306214510_be.service.AccommodationBookingService;
import apap.ti._5.accommodation_2306214510_be.service.PropertyService;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.*;

@RestController
@RequestMapping(&quot;/api/statistics&quot;)
@CrossOrigin(origins = &quot;*&quot;)
public class StatisticsRestController {

    private final PropertyService propertyService;
    private final AccommodationBookingService bookingService;

    public StatisticsRestController(PropertyService propertyService,
<span class="fc" id="L22">                                    AccommodationBookingService bookingService) {</span>
<span class="fc" id="L23">        this.propertyService = propertyService;</span>
<span class="fc" id="L24">        this.bookingService = bookingService;</span>
<span class="fc" id="L25">    }</span>

    // GET properties by type (for pie chart)
    @GetMapping(&quot;/properties-by-type&quot;)
    public ResponseEntity&lt;BaseResponseDTO&lt;Map&lt;String, Integer&gt;&gt;&gt; getPropertiesByType() {
<span class="fc" id="L30">        List&lt;Property&gt; allProperties = propertyService.getAllProperties();</span>

<span class="fc" id="L32">        Map&lt;String, Integer&gt; typeCount = new HashMap&lt;&gt;();</span>
<span class="fc" id="L33">        typeCount.put(&quot;Hotel&quot;, 0);</span>
<span class="fc" id="L34">        typeCount.put(&quot;Villa&quot;, 0);</span>
<span class="fc" id="L35">        typeCount.put(&quot;Apartment&quot;, 0);</span>

<span class="fc bfc" id="L37" title="All 2 branches covered.">        for (Property property : allProperties) {</span>
<span class="pc bpc" id="L38" title="1 of 4 branches missed.">            switch (property.getType()) {</span>
                case 1:
<span class="fc" id="L40">                    typeCount.put(&quot;Hotel&quot;, typeCount.get(&quot;Hotel&quot;) + 1);</span>
<span class="fc" id="L41">                    break;</span>
                case 2:
<span class="fc" id="L43">                    typeCount.put(&quot;Villa&quot;, typeCount.get(&quot;Villa&quot;) + 1);</span>
<span class="fc" id="L44">                    break;</span>
                case 3:
<span class="fc" id="L46">                    typeCount.put(&quot;Apartment&quot;, typeCount.get(&quot;Apartment&quot;) + 1);</span>
                    break;
            }
<span class="fc" id="L49">        }</span>

<span class="fc" id="L51">        return ResponseEntity.ok(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L52">                HttpStatus.OK.value(),</span>
                &quot;Success&quot;,
                typeCount
        ));
    }

    // GET bookings by status (for bar chart)
    @GetMapping(&quot;/bookings-by-status&quot;)
    public ResponseEntity&lt;BaseResponseDTO&lt;Map&lt;String, Long&gt;&gt;&gt; getBookingsByStatus() {
<span class="fc" id="L61">        Map&lt;String, Long&gt; statusCount = new LinkedHashMap&lt;&gt;();</span>
<span class="fc" id="L62">        statusCount.put(&quot;Waiting&quot;, (long) bookingService.getBookingsByStatus(0).size());</span>
<span class="fc" id="L63">        statusCount.put(&quot;Confirmed&quot;, (long) bookingService.getBookingsByStatus(1).size());</span>
<span class="fc" id="L64">        statusCount.put(&quot;Cancelled&quot;, (long) bookingService.getBookingsByStatus(2).size());</span>
<span class="fc" id="L65">        statusCount.put(&quot;Refund&quot;, (long) bookingService.getBookingsByStatus(3).size());</span>
<span class="fc" id="L66">        statusCount.put(&quot;Done&quot;, (long) bookingService.getBookingsByStatus(4).size());</span>

<span class="fc" id="L68">        return ResponseEntity.ok(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L69">                HttpStatus.OK.value(),</span>
                &quot;Success&quot;,
                statusCount
        ));
    }

    // GET top 5 properties by income (for bar chart)
    @GetMapping(&quot;/top-properties-by-income&quot;)
    public ResponseEntity&lt;BaseResponseDTO&lt;Map&lt;String, Integer&gt;&gt;&gt; getTopPropertiesByIncome() {
<span class="fc" id="L78">        List&lt;Property&gt; allProperties = propertyService.getAllProperties();</span>

        // Sort by income descending and take top 5
<span class="fc" id="L81">        allProperties.sort((p1, p2) -&gt; Integer.compare(p2.getIncome(), p1.getIncome()));</span>

<span class="fc" id="L83">        Map&lt;String, Integer&gt; topProperties = new LinkedHashMap&lt;&gt;();</span>
<span class="fc" id="L84">        int limit = Math.min(5, allProperties.size());</span>

<span class="fc bfc" id="L86" title="All 2 branches covered.">        for (int i = 0; i &lt; limit; i++) {</span>
<span class="fc" id="L87">            Property property = allProperties.get(i);</span>
<span class="fc" id="L88">            topProperties.put(property.getPropertyName(), property.getIncome());</span>
        }

<span class="fc" id="L91">        return ResponseEntity.ok(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L92">                HttpStatus.OK.value(),</span>
                &quot;Success&quot;,
                topProperties
        ));
    }

    // GET properties by province (for geographic visualization)
    @GetMapping(&quot;/properties-by-province&quot;)
    public ResponseEntity&lt;BaseResponseDTO&lt;Map&lt;String, Integer&gt;&gt;&gt; getPropertiesByProvince() {
<span class="fc" id="L101">        List&lt;Property&gt; allProperties = propertyService.getAllProperties();</span>

<span class="fc" id="L103">        Map&lt;String, Integer&gt; provinceCount = new HashMap&lt;&gt;();</span>

<span class="fc bfc" id="L105" title="All 2 branches covered.">        for (Property property : allProperties) {</span>
<span class="fc" id="L106">            String province = property.getProvince();</span>
<span class="fc" id="L107">            provinceCount.put(province, provinceCount.getOrDefault(province, 0) + 1);</span>
<span class="fc" id="L108">        }</span>

<span class="fc" id="L110">        return ResponseEntity.ok(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L111">                HttpStatus.OK.value(),</span>
                &quot;Success&quot;,
                provinceCount
        ));
    }

    // GET overall statistics summary
    @GetMapping(&quot;/summary&quot;)
    public ResponseEntity&lt;BaseResponseDTO&lt;Map&lt;String, Object&gt;&gt;&gt; getStatisticsSummary() {
<span class="fc" id="L120">        Map&lt;String, Object&gt; summary = new HashMap&lt;&gt;();</span>

        // Total counts
<span class="fc" id="L123">        summary.put(&quot;totalProperties&quot;, propertyService.countProperties());</span>
<span class="fc" id="L124">        summary.put(&quot;totalBookings&quot;, bookingService.countAllBookings());</span>

        // Active properties
<span class="fc" id="L127">        long activeProperties = propertyService.getAllProperties().stream()</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">                .filter(p -&gt; p.getActiveStatus() == 1)</span>
<span class="fc" id="L129">                .count();</span>
<span class="fc" id="L130">        summary.put(&quot;activeProperties&quot;, activeProperties);</span>

        // Total income from all properties
<span class="fc" id="L133">        int totalIncome = propertyService.getAllProperties().stream()</span>
<span class="fc" id="L134">                .mapToInt(Property::getIncome)</span>
<span class="fc" id="L135">                .sum();</span>
<span class="fc" id="L136">        summary.put(&quot;totalIncome&quot;, totalIncome);</span>

        // Confirmed bookings count
<span class="fc" id="L139">        long confirmedBookings = bookingService.getBookingsByStatus(1).size();</span>
<span class="fc" id="L140">        summary.put(&quot;confirmedBookings&quot;, confirmedBookings);</span>

<span class="fc" id="L142">        return ResponseEntity.ok(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L143">                HttpStatus.OK.value(),</span>
                &quot;Success&quot;,
                summary
        ));
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>