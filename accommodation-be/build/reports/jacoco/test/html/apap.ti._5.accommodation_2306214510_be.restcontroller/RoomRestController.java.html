<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RoomRestController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">accommodation-2306214510-be</a> &gt; <a href="index.source.html" class="el_package">apap.ti._5.accommodation_2306214510_be.restcontroller</a> &gt; <span class="el_source">RoomRestController.java</span></div><h1>RoomRestController.java</h1><pre class="source lang-java linenums">package apap.ti._5.accommodation_2306214510_be.restcontroller;

import apap.ti._5.accommodation_2306214510_be.repository.RoomRepository;
import apap.ti._5.accommodation_2306214510_be.dto.BaseResponseDTO;
import apap.ti._5.accommodation_2306214510_be.dto.RoomDTO;
import apap.ti._5.accommodation_2306214510_be.dto.RoomTypeSummaryDTO;
import apap.ti._5.accommodation_2306214510_be.dto.RoomDetailDTO;
import apap.ti._5.accommodation_2306214510_be.dto.request.MaintenanceRequestDTO;
import apap.ti._5.accommodation_2306214510_be.dto.request.RoomTypeRequestDTO;
import apap.ti._5.accommodation_2306214510_be.model.Property;
import apap.ti._5.accommodation_2306214510_be.model.Room;
import apap.ti._5.accommodation_2306214510_be.model.RoomType;
import apap.ti._5.accommodation_2306214510_be.service.PropertyService;
import apap.ti._5.accommodation_2306214510_be.service.RoomService;
import apap.ti._5.accommodation_2306214510_be.service.RoomTypeService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.Optional;
import java.util.List;
import java.time.LocalDateTime;
import java.util.stream.Collectors;
import java.util.stream.Collectors;

@RestController
@RequestMapping(&quot;/api/property&quot;)
@CrossOrigin(origins = &quot;*&quot;)
<span class="fc" id="L30">@Slf4j</span>
public class RoomRestController {

    private final PropertyService propertyService;
    private final RoomTypeService roomTypeService;
    private final RoomService roomService;
    private final RoomRepository roomRepository;

    public RoomRestController(PropertyService propertyService,
                              RoomTypeService roomTypeService,
                              RoomService roomService,
<span class="fc" id="L41">                              RoomRepository roomRepository) {</span>
<span class="fc" id="L42">        this.propertyService = propertyService;</span>
<span class="fc" id="L43">        this.roomTypeService = roomTypeService;</span>
<span class="fc" id="L44">        this.roomService = roomService;</span>
<span class="fc" id="L45">        this.roomRepository = roomRepository;</span>
<span class="fc" id="L46">    }</span>

    // POST add room type to existing property
    @PostMapping(&quot;/updateroom&quot;)
    public ResponseEntity&lt;BaseResponseDTO&lt;Property&gt;&gt; addRoomType(
            @RequestParam String propertyID,
            @RequestBody RoomTypeRequestDTO request) {

        try {
<span class="fc" id="L55">            Optional&lt;Property&gt; propertyOpt = propertyService.getPropertyById(propertyID);</span>

<span class="fc bfc" id="L57" title="All 2 branches covered.">            if (propertyOpt.isEmpty()) {</span>
<span class="fc" id="L58">                return ResponseEntity.status(HttpStatus.NOT_FOUND)</span>
<span class="fc" id="L59">                        .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L60">                                HttpStatus.NOT_FOUND.value(),</span>
                                &quot;Property not found&quot;,
                                null
                        ));
            }

<span class="fc" id="L66">            Property property = propertyOpt.get();</span>

            // Check for duplicate room type
<span class="fc bfc" id="L69" title="All 2 branches covered.">            if (roomTypeService.isDuplicateRoomType(property, request.getName(), request.getFloor())) {</span>
<span class="fc" id="L70">                return ResponseEntity.status(HttpStatus.BAD_REQUEST)</span>
<span class="fc" id="L71">                        .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L72">                                HttpStatus.BAD_REQUEST.value(),</span>
<span class="fc" id="L73">                                &quot;Duplicate room type: &quot; + request.getName() + &quot; on floor &quot; + request.getFloor(),</span>
                                null
                        ));
            }

            // Count properties for this owner to get propertyCount for ID generation
<span class="fc" id="L79">            long propertyCount = propertyService.countPropertiesByOwner(property.getOwnerID());</span>

            // Create room type
<span class="fc" id="L82">            RoomType roomType = new RoomType();</span>
<span class="fc" id="L83">            String roomTypeId = roomTypeService.generateRoomTypeId(propertyCount, request.getName(), request.getFloor());</span>
<span class="fc" id="L84">            roomType.setRoomTypeID(roomTypeId);</span>
<span class="fc" id="L85">            roomType.setName(request.getName());</span>
<span class="fc" id="L86">            roomType.setPrice(request.getPrice());</span>
<span class="fc" id="L87">            roomType.setDescription(request.getDescription());</span>
<span class="fc" id="L88">            roomType.setCapacity(request.getCapacity());</span>
<span class="fc" id="L89">            roomType.setFacility(request.getFacility());</span>
<span class="fc" id="L90">            roomType.setFloor(request.getFloor());</span>
<span class="fc" id="L91">            roomType.setProperty(property);</span>

<span class="fc" id="L93">            RoomType savedRoomType = roomTypeService.createRoomType(roomType);</span>

            // Get existing room count on this floor for this property
<span class="fc" id="L96">            int existingRoomsOnFloor = (int) roomService.countRoomsByPropertyAndFloor(propertyID, request.getFloor());</span>
            
            // Create rooms for this room type
<span class="fc bfc" id="L99" title="All 2 branches covered.">            for (int i = 1; i &lt;= request.getUnit(); i++) {</span>
<span class="fc" id="L100">                Room room = new Room();</span>
                // Room number: floor * 100 + next available number
<span class="fc" id="L102">                int roomNumber = request.getFloor() * 100 + existingRoomsOnFloor + i;</span>
<span class="fc" id="L103">                String roomId = roomService.generateRoomId(propertyID, roomNumber);</span>
<span class="fc" id="L104">                room.setRoomID(roomId);</span>
<span class="fc" id="L105">                room.setName(String.valueOf(roomNumber));</span>
<span class="fc" id="L106">                room.setRoomType(savedRoomType);</span>
<span class="fc" id="L107">                roomService.createRoom(room);</span>
            }

            // Refresh property with updated room types before calculating total rooms
<span class="fc" id="L111">            Optional&lt;Property&gt; refreshedPropertyOpt = propertyService.getPropertyById(propertyID);</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">            if (refreshedPropertyOpt.isEmpty()) {</span>
<span class="fc" id="L113">                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="fc" id="L114">                        .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L115">                                HttpStatus.INTERNAL_SERVER_ERROR.value(),</span>
                                &quot;Property not found after update&quot;,
                                null
                        ));
            }

<span class="fc" id="L121">            Property refreshedProperty = refreshedPropertyOpt.get();</span>
            // Update total rooms with refreshed data
<span class="fc" id="L123">            refreshedProperty.setTotalRoom(propertyService.calculateTotalRooms(refreshedProperty));</span>
<span class="fc" id="L124">            Property updatedProperty = propertyService.updateProperty(refreshedProperty);</span>

<span class="fc" id="L126">            return ResponseEntity.status(HttpStatus.CREATED)</span>
<span class="fc" id="L127">                    .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L128">                            HttpStatus.CREATED.value(),</span>
                            &quot;Room type added successfully&quot;,
                            updatedProperty
                    ));

<span class="fc" id="L133">        } catch (Exception e) {</span>
<span class="fc" id="L134">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="fc" id="L135">                    .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L136">                            HttpStatus.INTERNAL_SERVER_ERROR.value(),</span>
<span class="fc" id="L137">                            &quot;Error adding room type: &quot; + e.getMessage(),</span>
                            null
                    ));
        }
    }

    // POST schedule room maintenance
    @PostMapping(&quot;/maintenance/add&quot;)
    public ResponseEntity&lt;BaseResponseDTO&lt;Room&gt;&gt; scheduleRoomMaintenance(
            @RequestBody MaintenanceRequestDTO request) {

        try {
<span class="fc" id="L149">            Optional&lt;Room&gt; roomOpt = roomService.getRoomById(request.getRoomID());</span>

<span class="fc bfc" id="L151" title="All 2 branches covered.">            if (roomOpt.isEmpty()) {</span>
<span class="fc" id="L152">                return ResponseEntity.status(HttpStatus.NOT_FOUND)</span>
<span class="fc" id="L153">                        .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L154">                                HttpStatus.NOT_FOUND.value(),</span>
                                &quot;Room not found&quot;,
                                null
                        ));
            }

<span class="fc" id="L160">            Room room = roomOpt.get();</span>

            // Validate maintenance dates
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">            if (request.getMaintenanceEnd().isBefore(request.getMaintenanceStart())) {</span>
<span class="nc" id="L164">                return ResponseEntity.status(HttpStatus.BAD_REQUEST)</span>
<span class="nc" id="L165">                        .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="nc" id="L166">                                HttpStatus.BAD_REQUEST.value(),</span>
                                &quot;Maintenance end date must be after start date&quot;,
                                null
                        ));
            }

            // Schedule maintenance
<span class="fc" id="L173">            room.setMaintenanceStart(request.getMaintenanceStart());</span>
<span class="fc" id="L174">            room.setMaintenanceEnd(request.getMaintenanceEnd());</span>
<span class="fc" id="L175">            Room updatedRoom = roomService.updateRoom(room);</span>

<span class="fc" id="L177">            return ResponseEntity.ok(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L178">                    HttpStatus.OK.value(),</span>
                    &quot;Room maintenance scheduled successfully&quot;,
                    updatedRoom
            ));

<span class="fc" id="L183">        } catch (Exception e) {</span>
<span class="fc" id="L184">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="fc" id="L185">                    .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L186">                            HttpStatus.INTERNAL_SERVER_ERROR.value(),</span>
<span class="fc" id="L187">                            &quot;Error scheduling maintenance: &quot; + e.getMessage(),</span>
                            null
                    ));
        }
    }

    // GET rooms by property ID - returns room type summary with counts
    @GetMapping(&quot;/{propertyID}/rooms&quot;)
    public ResponseEntity&lt;BaseResponseDTO&lt;List&lt;RoomTypeSummaryDTO&gt;&gt;&gt; getRoomsByPropertyId(
            @PathVariable String propertyID) {
        try {
<span class="fc" id="L198">            Optional&lt;Property&gt; propertyOpt = propertyService.getPropertyById(propertyID);</span>

<span class="fc bfc" id="L200" title="All 2 branches covered.">            if (propertyOpt.isEmpty()) {</span>
<span class="fc" id="L201">                return ResponseEntity.status(HttpStatus.NOT_FOUND)</span>
<span class="fc" id="L202">                        .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L203">                                HttpStatus.NOT_FOUND.value(),</span>
                                &quot;Property not found&quot;,
                                null
                        ));
            }

<span class="fc" id="L209">            Property property = propertyOpt.get();</span>
            
            // Get room types for this property
<span class="fc" id="L212">            List&lt;RoomType&gt; roomTypes = roomTypeService.getRoomTypesByPropertyId(propertyID);</span>
            
            // Convert to summary DTOs with room counts
<span class="fc" id="L215">            List&lt;RoomTypeSummaryDTO&gt; summaries = roomTypes.stream().map(roomType -&gt; {</span>
                // Count total rooms of this type
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">                long totalRooms = roomType.getListRoom() != null ? roomType.getListRoom().size() : 0;</span>
                
                // Count available rooms (availability_status = 1)
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">                long availableRooms = roomType.getListRoom() != null ? </span>
<span class="fc" id="L221">                    roomType.getListRoom().stream()</span>
<span class="pc bpc" id="L222" title="1 of 2 branches missed.">                        .filter(room -&gt; room.getAvailabilityStatus() == 1)</span>
<span class="pc" id="L223">                        .count() : 0;</span>
                
<span class="fc" id="L225">                RoomTypeSummaryDTO dto = new RoomTypeSummaryDTO();</span>
<span class="fc" id="L226">                dto.setRoomTypeID(roomType.getRoomTypeID());</span>
<span class="fc" id="L227">                dto.setName(roomType.getName());</span>
<span class="fc" id="L228">                dto.setCapacity(roomType.getCapacity());</span>
<span class="fc" id="L229">                dto.setPrice(roomType.getPrice());</span>
<span class="fc" id="L230">                dto.setFloor(roomType.getFloor());</span>
<span class="fc" id="L231">                dto.setDescription(roomType.getDescription());</span>
<span class="fc" id="L232">                dto.setFacility(roomType.getFacility());</span>
<span class="fc" id="L233">                dto.setTotalRooms(totalRooms);</span>
<span class="fc" id="L234">                dto.setAvailableRooms(availableRooms);</span>
                
<span class="fc" id="L236">                return dto;</span>
<span class="fc" id="L237">            }).collect(Collectors.toList());</span>
            
<span class="fc" id="L239">            return ResponseEntity.ok(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L240">                    HttpStatus.OK.value(),</span>
                    &quot;Success&quot;,
                    summaries
            ));
<span class="nc" id="L244">        } catch (Exception e) {</span>
<span class="nc" id="L245">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L246">                    .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="nc" id="L247">                            HttpStatus.INTERNAL_SERVER_ERROR.value(),</span>
<span class="nc" id="L248">                            &quot;Error fetching rooms: &quot; + e.getMessage(),</span>
                            null
                    ));
        }
    }

    // GET check room availability for date range
    @GetMapping(&quot;/{propertyID}/rooms/available&quot;)
    public ResponseEntity&lt;BaseResponseDTO&lt;List&lt;RoomTypeSummaryDTO&gt;&gt;&gt; checkRoomAvailability(
            @PathVariable String propertyID,
            @RequestParam String checkIn,
            @RequestParam String checkOut) {
        
        try {
<span class="fc" id="L262">            Optional&lt;Property&gt; propertyOpt = propertyService.getPropertyById(propertyID);</span>
            
<span class="fc bfc" id="L264" title="All 2 branches covered.">            if (propertyOpt.isEmpty()) {</span>
<span class="fc" id="L265">                return ResponseEntity.status(HttpStatus.NOT_FOUND)</span>
<span class="fc" id="L266">                        .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L267">                                HttpStatus.NOT_FOUND.value(),</span>
                                &quot;Property not found&quot;,
                                null
                        ));
            }

            // Parse check-in and check-out dates
<span class="fc" id="L274">            LocalDateTime checkInDateTime = LocalDateTime.parse(checkIn);</span>
<span class="fc" id="L275">            LocalDateTime checkOutDateTime = LocalDateTime.parse(checkOut);</span>

<span class="fc" id="L277">            log.info(&quot;=== CHECK ROOM AVAILABILITY ===&quot;);</span>
<span class="fc" id="L278">            log.info(&quot;Property ID: {}&quot;, propertyID);</span>
<span class="fc" id="L279">            log.info(&quot;Check-In: {}&quot;, checkInDateTime);</span>
<span class="fc" id="L280">            log.info(&quot;Check-Out: {}&quot;, checkOutDateTime);</span>

            // Get all room types for property (fresh query)
<span class="fc" id="L283">            List&lt;RoomType&gt; roomTypes = roomTypeService.getRoomTypesByPropertyId(propertyID);</span>
<span class="fc" id="L284">            log.info(&quot;Found {} room types&quot;, roomTypes.size());</span>
            
            // Check availability for each room type
<span class="fc" id="L287">            List&lt;RoomTypeSummaryDTO&gt; summaries = roomTypes.stream().map(roomType -&gt; {</span>
<span class="pc bpc" id="L288" title="1 of 2 branches missed.">                long totalRooms = roomType.getListRoom() != null ? roomType.getListRoom().size() : 0;</span>
                
                // Count available rooms by querying each room individually (forces fresh load from DB)
<span class="fc" id="L291">                long availableRooms = 0;</span>
<span class="pc bpc" id="L292" title="1 of 2 branches missed.">                if (roomType.getListRoom() != null) {</span>
<span class="pc bpc" id="L293" title="1 of 2 branches missed.">                    for (Room room : roomType.getListRoom()) {</span>
                        // Re-fetch room from DB to ensure we get latest maintenance data
<span class="nc" id="L295">                        Optional&lt;Room&gt; freshRoom = roomRepository.findById(room.getRoomID());</span>
<span class="nc bnc" id="L296" title="All 4 branches missed.">                        boolean isAvailable = freshRoom.isPresent() &amp;&amp; roomService.isRoomAvailable(room.getRoomID(), checkInDateTime, checkOutDateTime);</span>
<span class="nc" id="L297">                        log.info(&quot;Room: {} - Available: {}&quot;, room.getRoomID(), isAvailable);</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">                        if (isAvailable) {</span>
<span class="nc" id="L299">                            availableRooms++;</span>
                        }
<span class="nc" id="L301">                    }</span>
                }
                
<span class="fc" id="L304">                log.info(&quot;RoomType: {} - Total: {} - Available: {}&quot;, roomType.getName(), totalRooms, availableRooms);</span>
                
<span class="fc" id="L306">                RoomTypeSummaryDTO dto = new RoomTypeSummaryDTO();</span>
<span class="fc" id="L307">                dto.setRoomTypeID(roomType.getRoomTypeID());</span>
<span class="fc" id="L308">                dto.setName(roomType.getName());</span>
<span class="fc" id="L309">                dto.setCapacity(roomType.getCapacity());</span>
<span class="fc" id="L310">                dto.setPrice(roomType.getPrice());</span>
<span class="fc" id="L311">                dto.setFloor(roomType.getFloor());</span>
<span class="fc" id="L312">                dto.setDescription(roomType.getDescription());</span>
<span class="fc" id="L313">                dto.setFacility(roomType.getFacility());</span>
<span class="fc" id="L314">                dto.setTotalRooms(totalRooms);</span>
<span class="fc" id="L315">                dto.setAvailableRooms(availableRooms);</span>
<span class="fc" id="L316">                return dto;</span>
<span class="fc" id="L317">            }).collect(Collectors.toList());</span>
            
<span class="fc" id="L319">            return ResponseEntity.ok(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L320">                    HttpStatus.OK.value(),</span>
                    &quot;Success&quot;,
                    summaries
            ));
<span class="nc" id="L324">        } catch (Exception e) {</span>
<span class="nc" id="L325">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L326">                    .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="nc" id="L327">                            HttpStatus.INTERNAL_SERVER_ERROR.value(),</span>
<span class="nc" id="L328">                            &quot;Error checking availability: &quot; + e.getMessage(),</span>
                            null
                    ));
        }
    }

    // GET check if a single room is available for date range
    @GetMapping(&quot;/room/{roomID}/available&quot;)
    public ResponseEntity&lt;BaseResponseDTO&lt;Boolean&gt;&gt; checkSingleRoomAvailability(
            @PathVariable String roomID,
            @RequestParam String checkIn,
            @RequestParam String checkOut) {
        
        try {
<span class="fc" id="L342">            Optional&lt;Room&gt; roomOpt = roomRepository.findById(roomID);</span>
            
<span class="fc bfc" id="L344" title="All 2 branches covered.">            if (roomOpt.isEmpty()) {</span>
<span class="fc" id="L345">                return ResponseEntity.status(HttpStatus.NOT_FOUND)</span>
<span class="fc" id="L346">                        .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L347">                                HttpStatus.NOT_FOUND.value(),</span>
                                &quot;Room not found&quot;,
                                null
                        ));
            }

            // Parse check-in and check-out dates
<span class="fc" id="L354">            LocalDateTime checkInDateTime = LocalDateTime.parse(checkIn);</span>
<span class="fc" id="L355">            LocalDateTime checkOutDateTime = LocalDateTime.parse(checkOut);</span>

<span class="fc" id="L357">            log.info(&quot;=== CHECK SINGLE ROOM AVAILABILITY ===&quot;);</span>
<span class="fc" id="L358">            log.info(&quot;Room ID: {}&quot;, roomID);</span>
<span class="fc" id="L359">            log.info(&quot;Check-In: {}&quot;, checkInDateTime);</span>
<span class="fc" id="L360">            log.info(&quot;Check-Out: {}&quot;, checkOutDateTime);</span>

            // Check if room is available
<span class="fc" id="L363">            boolean isAvailable = roomService.isRoomAvailable(roomID, checkInDateTime, checkOutDateTime);</span>
            
<span class="fc" id="L365">            log.info(&quot;Room {} is available: {}&quot;, roomID, isAvailable);</span>
            
<span class="fc" id="L367">            return ResponseEntity.ok(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L368">                    HttpStatus.OK.value(),</span>
<span class="fc bfc" id="L369" title="All 2 branches covered.">                    isAvailable ? &quot;Room is available&quot; : &quot;Room is not available&quot;,</span>
<span class="fc" id="L370">                    isAvailable</span>
            ));
<span class="nc" id="L372">        } catch (Exception e) {</span>
<span class="nc" id="L373">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L374">                    .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="nc" id="L375">                            HttpStatus.INTERNAL_SERVER_ERROR.value(),</span>
<span class="nc" id="L376">                            &quot;Error checking room availability: &quot; + e.getMessage(),</span>
                            null
                    ));
        }
    }

    // GET all individual rooms for a property
    @GetMapping(&quot;/{propertyID}/all-rooms&quot;)
    public ResponseEntity&lt;BaseResponseDTO&lt;List&lt;RoomDetailDTO&gt;&gt;&gt; getAllRooms(
            @PathVariable String propertyID) {
        try {
<span class="fc" id="L387">            Optional&lt;Property&gt; propertyOpt = propertyService.getPropertyById(propertyID);</span>

<span class="fc bfc" id="L389" title="All 2 branches covered.">            if (propertyOpt.isEmpty()) {</span>
<span class="fc" id="L390">                return ResponseEntity.status(HttpStatus.NOT_FOUND)</span>
<span class="fc" id="L391">                        .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L392">                                HttpStatus.NOT_FOUND.value(),</span>
                                &quot;Property not found&quot;,
                                null
                        ));
            }

            // Get all room types for property
<span class="fc" id="L399">            List&lt;RoomType&gt; roomTypes = roomTypeService.getRoomTypesByPropertyId(propertyID);</span>
            
            // Collect all individual rooms
<span class="fc" id="L402">            List&lt;RoomDetailDTO&gt; allRooms = new java.util.ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L403" title="1 of 2 branches missed.">            for (RoomType roomType : roomTypes) {</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">                if (roomType.getListRoom() != null) {</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">                    for (Room room : roomType.getListRoom()) {</span>
<span class="nc" id="L406">                        RoomDetailDTO dto = new RoomDetailDTO();</span>
<span class="nc" id="L407">                        dto.setRoomID(room.getRoomID());</span>
<span class="nc" id="L408">                        dto.setName(room.getName());</span>
<span class="nc" id="L409">                        dto.setAvailabilityStatus(room.getAvailabilityStatus());</span>
<span class="nc" id="L410">                        dto.setActiveRoom(room.getActiveRoom());</span>
<span class="nc" id="L411">                        dto.setRoomTypeID(room.getRoomType().getRoomTypeID());</span>
<span class="nc" id="L412">                        allRooms.add(dto);</span>
<span class="nc" id="L413">                    }</span>
                }
<span class="nc" id="L415">            }</span>
            
<span class="fc" id="L417">            return ResponseEntity.ok(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L418">                    HttpStatus.OK.value(),</span>
                    &quot;Success&quot;,
                    allRooms
            ));
<span class="nc" id="L422">        } catch (Exception e) {</span>
<span class="nc" id="L423">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L424">                    .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="nc" id="L425">                            HttpStatus.INTERNAL_SERVER_ERROR.value(),</span>
<span class="nc" id="L426">                            &quot;Error fetching all rooms: &quot; + e.getMessage(),</span>
                            null
                    ));
        }
    }

    // PUT sync totalRoom count for a property
    @PutMapping(&quot;/{propertyID}/sync-total-rooms&quot;)
    public ResponseEntity&lt;BaseResponseDTO&lt;Property&gt;&gt; syncTotalRooms(
            @PathVariable String propertyID) {
        try {
<span class="fc" id="L437">            Optional&lt;Property&gt; propertyOpt = propertyService.getPropertyById(propertyID);</span>

<span class="fc bfc" id="L439" title="All 2 branches covered.">            if (propertyOpt.isEmpty()) {</span>
<span class="fc" id="L440">                return ResponseEntity.status(HttpStatus.NOT_FOUND)</span>
<span class="fc" id="L441">                        .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L442">                                HttpStatus.NOT_FOUND.value(),</span>
                                &quot;Property not found&quot;,
                                null
                        ));
            }

<span class="fc" id="L448">            Property property = propertyOpt.get();</span>
            
            // Refresh room types from database to ensure relationships are loaded
<span class="fc" id="L451">            List&lt;RoomType&gt; roomTypes = roomTypeService.getRoomTypesByPropertyId(propertyID);</span>
<span class="fc" id="L452">            property.setListRoomType(roomTypes);</span>
            
            // Recalculate total rooms
<span class="fc" id="L455">            int totalRooms = propertyService.calculateTotalRooms(property);</span>
<span class="fc" id="L456">            property.setTotalRoom(totalRooms);</span>
            
            // Update property in database
<span class="fc" id="L459">            Property updatedProperty = propertyService.updateProperty(property);</span>

<span class="fc" id="L461">            return ResponseEntity.ok(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L462">                    HttpStatus.OK.value(),</span>
                    &quot;Total rooms synced successfully. New total: &quot; + totalRooms,
                    updatedProperty
            ));
<span class="nc" id="L466">        } catch (Exception e) {</span>
<span class="nc" id="L467">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L468">                    .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="nc" id="L469">                            HttpStatus.INTERNAL_SERVER_ERROR.value(),</span>
<span class="nc" id="L470">                            &quot;Error syncing total rooms: &quot; + e.getMessage(),</span>
                            null
                    ));
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>