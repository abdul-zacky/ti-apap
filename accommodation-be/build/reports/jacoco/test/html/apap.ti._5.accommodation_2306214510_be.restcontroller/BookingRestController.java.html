<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BookingRestController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">accommodation-2306214510-be</a> &gt; <a href="index.source.html" class="el_package">apap.ti._5.accommodation_2306214510_be.restcontroller</a> &gt; <span class="el_source">BookingRestController.java</span></div><h1>BookingRestController.java</h1><pre class="source lang-java linenums">package apap.ti._5.accommodation_2306214510_be.restcontroller;

import apap.ti._5.accommodation_2306214510_be.dto.BaseResponseDTO;
import apap.ti._5.accommodation_2306214510_be.dto.request.BookingRequestDTO;
import apap.ti._5.accommodation_2306214510_be.model.AccommodationBooking;
import apap.ti._5.accommodation_2306214510_be.model.Property;
import apap.ti._5.accommodation_2306214510_be.model.Room;
import apap.ti._5.accommodation_2306214510_be.repository.AccommodationBookingRepository;
import apap.ti._5.accommodation_2306214510_be.repository.RoomRepository;
import apap.ti._5.accommodation_2306214510_be.service.AccommodationBookingService;
import apap.ti._5.accommodation_2306214510_be.service.PropertyService;
import apap.ti._5.accommodation_2306214510_be.service.RoomService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;

@RestController
@RequestMapping(&quot;/api/booking&quot;)
@CrossOrigin(origins = &quot;*&quot;)
<span class="fc" id="L25">@Slf4j</span>
public class BookingRestController {

    private final AccommodationBookingService bookingService;
    private final RoomService roomService;
    private final PropertyService propertyService;
    private final RoomRepository roomRepository;
    private final AccommodationBookingRepository bookingRepository;

    public BookingRestController(AccommodationBookingService bookingService,
                                 RoomService roomService,
                                 PropertyService propertyService,
                                 RoomRepository roomRepository,
<span class="fc" id="L38">                                 AccommodationBookingRepository bookingRepository) {</span>
<span class="fc" id="L39">        this.bookingService = bookingService;</span>
<span class="fc" id="L40">        this.roomService = roomService;</span>
<span class="fc" id="L41">        this.propertyService = propertyService;</span>
<span class="fc" id="L42">        this.roomRepository = roomRepository;</span>
<span class="fc" id="L43">        this.bookingRepository = bookingRepository;</span>
<span class="fc" id="L44">    }</span>

    // GET all bookings with optional filters
    @GetMapping(&quot;&quot;)
    public ResponseEntity&lt;BaseResponseDTO&lt;List&lt;AccommodationBooking&gt;&gt;&gt; getAllBookings(
            @RequestParam(required = false) String searchTerm,
            @RequestParam(required = false) Integer status) {

        List&lt;AccommodationBooking&gt; bookings;

        // If both filters are provided
<span class="fc bfc" id="L55" title="All 4 branches covered.">        if (searchTerm != null &amp;&amp; status != null) {</span>
<span class="fc" id="L56">            bookings = bookingService.searchBookings(searchTerm, status);</span>
        }
        // If only status filter is provided
<span class="fc bfc" id="L59" title="All 2 branches covered.">        else if (status != null) {</span>
<span class="fc" id="L60">            bookings = bookingService.getBookingsByStatus(status);</span>
        }
        // If only searchTerm filter is provided
<span class="fc bfc" id="L63" title="All 2 branches covered.">        else if (searchTerm != null) {</span>
<span class="fc" id="L64">            bookings = bookingService.searchBookings(searchTerm, null);</span>
        }
        // If no filters are provided
        else {
<span class="fc" id="L68">            bookings = bookingService.getAllBookings();</span>
        }

<span class="fc" id="L71">        return ResponseEntity.ok(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L72">                HttpStatus.OK.value(),</span>
                &quot;Success&quot;,
                bookings
        ));
    }

    // GET booking by ID
    @GetMapping(&quot;/{id}&quot;)
    public ResponseEntity&lt;BaseResponseDTO&lt;AccommodationBooking&gt;&gt; getBookingById(@PathVariable String id) {
<span class="fc" id="L81">        Optional&lt;AccommodationBooking&gt; booking = bookingService.getBookingById(id);</span>

<span class="fc bfc" id="L83" title="All 2 branches covered.">        if (booking.isEmpty()) {</span>
<span class="fc" id="L84">            return ResponseEntity.status(HttpStatus.NOT_FOUND)</span>
<span class="fc" id="L85">                    .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L86">                            HttpStatus.NOT_FOUND.value(),</span>
                            &quot;Booking not found&quot;,
                            null
                    ));
        }

<span class="fc" id="L92">        return ResponseEntity.ok(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L93">                HttpStatus.OK.value(),</span>
                &quot;Success&quot;,
<span class="fc" id="L95">                booking.get()</span>
        ));
    }

    // POST create booking
    @PostMapping(&quot;/create&quot;)
    public ResponseEntity&lt;BaseResponseDTO&lt;AccommodationBooking&gt;&gt; createBooking(
            @RequestBody BookingRequestDTO request) {

        try {
<span class="fc" id="L105">            log.info(&quot;=== CREATE BOOKING ===&quot;);</span>
<span class="fc" id="L106">            log.info(&quot;Room ID: {}&quot;, request.getRoomID());</span>
<span class="fc" id="L107">            log.info(&quot;Check-In: {}&quot;, request.getCheckInDate());</span>
<span class="fc" id="L108">            log.info(&quot;Check-Out: {}&quot;, request.getCheckOutDate());</span>
<span class="fc" id="L109">            log.info(&quot;Customer: {}&quot;, request.getCustomerName());</span>
            
            // Validate room exists
<span class="fc" id="L112">            Optional&lt;Room&gt; roomOpt = roomService.getRoomById(request.getRoomID());</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">            if (roomOpt.isEmpty()) {</span>
<span class="fc" id="L114">                log.warn(&quot;Room not found: {}&quot;, request.getRoomID());</span>
<span class="fc" id="L115">                return ResponseEntity.status(HttpStatus.NOT_FOUND)</span>
<span class="fc" id="L116">                        .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L117">                                HttpStatus.NOT_FOUND.value(),</span>
                                &quot;Room not found&quot;,
                                null
                        ));
            }

<span class="fc" id="L123">            Room room = roomOpt.get();</span>

            // Validate dates
<span class="fc bfc" id="L126" title="All 2 branches covered.">            if (request.getCheckOutDate().isBefore(request.getCheckInDate())) {</span>
<span class="fc" id="L127">                log.warn(&quot;Invalid dates: CheckOut before CheckIn&quot;);</span>
<span class="fc" id="L128">                return ResponseEntity.status(HttpStatus.BAD_REQUEST)</span>
<span class="fc" id="L129">                        .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L130">                                HttpStatus.BAD_REQUEST.value(),</span>
                                &quot;Check-out date must be after check-in date&quot;,
                                null
                        ));
            }

            // Check room availability
<span class="fc" id="L137">            log.info(&quot;Checking room availability...&quot;);</span>
<span class="fc" id="L138">            boolean isAvailable = roomService.isRoomAvailable(request.getRoomID(), request.getCheckInDate(), request.getCheckOutDate());</span>
<span class="fc" id="L139">            log.info(&quot;Room available: {}&quot;, isAvailable);</span>
            
<span class="fc bfc" id="L141" title="All 2 branches covered.">            if (!isAvailable) {</span>
<span class="fc" id="L142">                log.warn(&quot;Room is not available for requested dates&quot;);</span>
<span class="fc" id="L143">                return ResponseEntity.status(HttpStatus.BAD_REQUEST)</span>
<span class="fc" id="L144">                        .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L145">                                HttpStatus.BAD_REQUEST.value(),</span>
                                &quot;Room is not available for the selected dates&quot;,
                                null
                        ));
            }

            // Create booking
<span class="fc" id="L152">            AccommodationBooking booking = new AccommodationBooking();</span>
<span class="fc" id="L153">            String bookingId = bookingService.generateBookingId(request.getRoomID(), request.getCheckInDate());</span>
<span class="fc" id="L154">            booking.setBookingID(bookingId);</span>
<span class="fc" id="L155">            booking.setRoom(room);</span>
<span class="fc" id="L156">            booking.setCheckInDate(request.getCheckInDate());</span>
<span class="fc" id="L157">            booking.setCheckOutDate(request.getCheckOutDate());</span>
<span class="fc" id="L158">            booking.setCustomerID(request.getCustomerID());</span>
<span class="fc" id="L159">            booking.setCustomerName(request.getCustomerName());</span>
<span class="fc" id="L160">            booking.setCustomerEmail(request.getCustomerEmail());</span>
<span class="fc" id="L161">            booking.setCustomerPhone(request.getCustomerPhone());</span>
<span class="fc" id="L162">            booking.setBreakfast(request.isBreakfast());</span>
<span class="fc" id="L163">            booking.setCapacity(request.getCapacity());</span>
<span class="fc" id="L164">            booking.setStatus(0); // Waiting for payment</span>
<span class="fc" id="L165">            booking.setExtraPay(0);</span>
<span class="fc" id="L166">            booking.setRefund(0);</span>

            // Calculate price
<span class="fc" id="L169">            int totalDays = bookingService.calculateTotalDays(request.getCheckInDate(), request.getCheckOutDate());</span>
<span class="fc" id="L170">            int totalPrice = bookingService.calculateTotalPrice(room, totalDays, request.isBreakfast());</span>
<span class="fc" id="L171">            booking.setTotalPrice(totalPrice);</span>
<span class="fc" id="L172">            booking.setTotalDays(totalDays);</span>

<span class="fc" id="L174">            log.info(&quot;Saving booking with ID: {} Status: 0 (Waiting) TotalDays: {} TotalPrice: {}&quot;, bookingId, totalDays, totalPrice);</span>
<span class="fc" id="L175">            AccommodationBooking savedBooking = bookingService.createBooking(booking);</span>
            
<span class="fc" id="L177">            log.info(&quot;Booking saved successfully!&quot;);</span>
<span class="fc" id="L178">            log.info(&quot;Saved Booking ID: {} Status: {} CheckIn: {} CheckOut: {}&quot;, </span>
<span class="fc" id="L179">                savedBooking.getBookingID(), savedBooking.getStatus(), savedBooking.getCheckInDate(), savedBooking.getCheckOutDate());</span>

<span class="fc" id="L181">            return ResponseEntity.status(HttpStatus.CREATED)</span>
<span class="fc" id="L182">                    .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L183">                            HttpStatus.CREATED.value(),</span>
                            &quot;Booking created successfully&quot;,
                            savedBooking
                    ));

<span class="fc" id="L188">        } catch (Exception e) {</span>
<span class="fc" id="L189">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="fc" id="L190">                    .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L191">                            HttpStatus.INTERNAL_SERVER_ERROR.value(),</span>
<span class="fc" id="L192">                            &quot;Error creating booking: &quot; + e.getMessage(),</span>
                            null
                    ));
        }
    }

    // PUT confirm payment
    @PutMapping(&quot;/confirm/{id}&quot;)
    public ResponseEntity&lt;BaseResponseDTO&lt;AccommodationBooking&gt;&gt; confirmPayment(@PathVariable String id) {
        try {
<span class="fc" id="L202">            log.info(&quot;=== CONFIRM BOOKING PAYMENT ===&quot;);</span>
<span class="fc" id="L203">            log.info(&quot;Booking ID: {}&quot;, id);</span>
            
<span class="fc" id="L205">            Optional&lt;AccommodationBooking&gt; bookingOpt = bookingService.getBookingById(id);</span>

<span class="fc bfc" id="L207" title="All 2 branches covered.">            if (bookingOpt.isEmpty()) {</span>
<span class="fc" id="L208">                log.warn(&quot;Booking not found: {}&quot;, id);</span>
<span class="fc" id="L209">                return ResponseEntity.status(HttpStatus.NOT_FOUND)</span>
<span class="fc" id="L210">                        .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L211">                                HttpStatus.NOT_FOUND.value(),</span>
                                &quot;Booking not found&quot;,
                                null
                        ));
            }

<span class="fc" id="L217">            AccommodationBooking booking = bookingOpt.get();</span>
<span class="fc" id="L218">            log.info(&quot;Current booking status: {}&quot;, booking.getStatus());</span>
<span class="fc" id="L219">            log.info(&quot;Room ID: {} CheckIn: {} CheckOut: {}&quot;, booking.getRoom().getRoomID(), booking.getCheckInDate(), booking.getCheckOutDate());</span>

<span class="fc bfc" id="L221" title="All 2 branches covered.">            if (booking.getStatus() != 0) {</span>
<span class="fc" id="L222">                log.warn(&quot;Booking status is not 0, current status: {}&quot;, booking.getStatus());</span>
<span class="fc" id="L223">                return ResponseEntity.status(HttpStatus.BAD_REQUEST)</span>
<span class="fc" id="L224">                        .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L225">                                HttpStatus.BAD_REQUEST.value(),</span>
                                &quot;Only bookings with status 0 can be confirmed&quot;,
                                null
                        ));
            }

            // Confirm booking and update property income
<span class="fc" id="L232">            log.info(&quot;Confirming booking...&quot;);</span>
<span class="fc" id="L233">            AccommodationBooking updatedBooking = bookingService.payBooking(id);</span>
<span class="fc" id="L234">            log.info(&quot;Booking confirmed! New status: {}&quot;, updatedBooking.getStatus());</span>

<span class="fc" id="L236">            return ResponseEntity.ok(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L237">                    HttpStatus.OK.value(),</span>
                    &quot;Payment confirmed successfully&quot;,
                    updatedBooking
            ));

<span class="fc" id="L242">        } catch (Exception e) {</span>
<span class="fc" id="L243">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="fc" id="L244">                    .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L245">                            HttpStatus.INTERNAL_SERVER_ERROR.value(),</span>
<span class="fc" id="L246">                            &quot;Error confirming payment: &quot; + e.getMessage(),</span>
                            null
                    ));
        }
    }

    // PUT cancel booking
    @PutMapping(&quot;/cancel/{id}&quot;)
    public ResponseEntity&lt;BaseResponseDTO&lt;AccommodationBooking&gt;&gt; cancelBooking(@PathVariable String id) {
        try {
<span class="fc" id="L256">            Optional&lt;AccommodationBooking&gt; bookingOpt = bookingService.getBookingById(id);</span>

<span class="fc bfc" id="L258" title="All 2 branches covered.">            if (bookingOpt.isEmpty()) {</span>
<span class="fc" id="L259">                return ResponseEntity.status(HttpStatus.NOT_FOUND)</span>
<span class="fc" id="L260">                        .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L261">                                HttpStatus.NOT_FOUND.value(),</span>
                                &quot;Booking not found&quot;,
                                null
                        ));
            }

<span class="fc" id="L267">            AccommodationBooking booking = bookingOpt.get();</span>

<span class="fc bfc" id="L269" title="All 6 branches covered.">            if (booking.getStatus() == 2 || booking.getStatus() == 3 || booking.getStatus() == 4) {</span>
<span class="fc" id="L270">                return ResponseEntity.status(HttpStatus.BAD_REQUEST)</span>
<span class="fc" id="L271">                        .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L272">                                HttpStatus.BAD_REQUEST.value(),</span>
                                &quot;Cannot cancel booking with current status&quot;,
                                null
                        ));
            }

            // Cancel booking (will handle refund if needed)
<span class="fc" id="L279">            AccommodationBooking updatedBooking = bookingService.cancelBooking(id);</span>

<span class="fc" id="L281">            return ResponseEntity.ok(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L282">                    HttpStatus.OK.value(),</span>
                    &quot;Booking cancelled successfully&quot;,
                    updatedBooking
            ));

<span class="fc" id="L287">        } catch (Exception e) {</span>
<span class="fc" id="L288">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="fc" id="L289">                    .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L290">                            HttpStatus.INTERNAL_SERVER_ERROR.value(),</span>
<span class="fc" id="L291">                            &quot;Error cancelling booking: &quot; + e.getMessage(),</span>
                            null
                    ));
        }
    }

    // PUT complete booking
    @PutMapping(&quot;/complete/{id}&quot;)
    public ResponseEntity&lt;BaseResponseDTO&lt;AccommodationBooking&gt;&gt; completeBooking(@PathVariable String id) {
        try {
<span class="fc" id="L301">            Optional&lt;AccommodationBooking&gt; bookingOpt = bookingService.getBookingById(id);</span>

<span class="fc bfc" id="L303" title="All 2 branches covered.">            if (bookingOpt.isEmpty()) {</span>
<span class="fc" id="L304">                return ResponseEntity.status(HttpStatus.NOT_FOUND)</span>
<span class="fc" id="L305">                        .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L306">                                HttpStatus.NOT_FOUND.value(),</span>
                                &quot;Booking not found&quot;,
                                null
                        ));
            }

<span class="fc" id="L312">            AccommodationBooking booking = bookingOpt.get();</span>

<span class="fc bfc" id="L314" title="All 2 branches covered.">            if (booking.getStatus() != 1) {</span>
<span class="fc" id="L315">                return ResponseEntity.status(HttpStatus.BAD_REQUEST)</span>
<span class="fc" id="L316">                        .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L317">                                HttpStatus.BAD_REQUEST.value(),</span>
                                &quot;Only confirmed bookings can be completed&quot;,
                                null
                        ));
            }

<span class="fc" id="L323">            booking.setStatus(4); // Done</span>
<span class="fc" id="L324">            AccommodationBooking updatedBooking = bookingService.updateBookingDetails(booking);</span>

<span class="fc" id="L326">            return ResponseEntity.ok(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L327">                    HttpStatus.OK.value(),</span>
                    &quot;Booking completed successfully&quot;,
                    updatedBooking
            ));

<span class="fc" id="L332">        } catch (Exception e) {</span>
<span class="fc" id="L333">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="fc" id="L334">                    .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L335">                            HttpStatus.INTERNAL_SERVER_ERROR.value(),</span>
<span class="fc" id="L336">                            &quot;Error completing booking: &quot; + e.getMessage(),</span>
                            null
                    ));
        }
    }

    // PUT process refund
    @PutMapping(&quot;/refund/{id}&quot;)
    public ResponseEntity&lt;BaseResponseDTO&lt;AccommodationBooking&gt;&gt; processRefund(@PathVariable String id) {
        try {
<span class="fc" id="L346">            log.info(&quot;üí∞ PUT /booking/refund/{} - Processing refund&quot;, id);</span>
            
<span class="fc" id="L348">            Optional&lt;AccommodationBooking&gt; bookingOpt = bookingService.getBookingById(id);</span>

<span class="fc bfc" id="L350" title="All 2 branches covered.">            if (bookingOpt.isEmpty()) {</span>
<span class="fc" id="L351">                return ResponseEntity.status(HttpStatus.NOT_FOUND)</span>
<span class="fc" id="L352">                        .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L353">                                HttpStatus.NOT_FOUND.value(),</span>
                                &quot;Booking not found&quot;,
                                null
                        ));
            }

<span class="fc" id="L359">            AccommodationBooking booking = bookingOpt.get();</span>

            // Only allow refund for status 3 (Request Refund) with negative extraPay
<span class="fc bfc" id="L362" title="All 2 branches covered.">            if (booking.getStatus() != 3) {</span>
<span class="fc" id="L363">                return ResponseEntity.status(HttpStatus.BAD_REQUEST)</span>
<span class="fc" id="L364">                        .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L365">                                HttpStatus.BAD_REQUEST.value(),</span>
                                &quot;Only bookings with status 'Request Refund' can be processed&quot;,
                                null
                        ));
            }

<span class="fc bfc" id="L371" title="All 2 branches covered.">            if (booking.getExtraPay() &gt;= 0) {</span>
<span class="fc" id="L372">                return ResponseEntity.status(HttpStatus.BAD_REQUEST)</span>
<span class="fc" id="L373">                        .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L374">                                HttpStatus.BAD_REQUEST.value(),</span>
                                &quot;No refund amount found for this booking&quot;,
                                null
                        ));
            }

            // Get refund amount (negative extraPay)
<span class="fc" id="L381">            int refundAmount = Math.abs(booking.getExtraPay());</span>
<span class="fc" id="L382">            String propertyId = booking.getRoom().getRoomType().getProperty().getPropertyID();</span>
            
<span class="fc" id="L384">            log.info(&quot;üí∞ Refunding Rp {} to customer, reducing property {} income&quot;, refundAmount, propertyId);</span>
            
            // Reduce property income
<span class="fc" id="L387">            bookingService.updatePropertyIncome(propertyId, refundAmount, false);</span>
            
            // Update booking status and clear extraPay
<span class="fc" id="L390">            booking.setStatus(1); // Back to Confirmed</span>
<span class="fc" id="L391">            booking.setExtraPay(0); // Clear refund amount</span>
<span class="fc" id="L392">            booking.setUpdatedDate(LocalDateTime.now());</span>
            
<span class="fc" id="L394">            AccommodationBooking updatedBooking = bookingRepository.save(booking);</span>
            
<span class="fc" id="L396">            log.info(&quot;‚úÖ Refund processed successfully&quot;);</span>

<span class="fc" id="L398">            return ResponseEntity.ok(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L399">                    HttpStatus.OK.value(),</span>
                    &quot;Refund processed successfully - Rp &quot; + refundAmount,
                    updatedBooking
            ));

<span class="fc" id="L404">        } catch (Exception e) {</span>
<span class="fc" id="L405">            log.error(&quot;‚ùå Error processing refund: {}&quot;, e.getMessage());</span>
<span class="fc" id="L406">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="fc" id="L407">                    .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L408">                            HttpStatus.INTERNAL_SERVER_ERROR.value(),</span>
<span class="fc" id="L409">                            &quot;Error processing refund: &quot; + e.getMessage(),</span>
                            null
                    ));
        }
    }

    // PUT update booking details
    @PutMapping(&quot;/update/{id}&quot;)
    public ResponseEntity&lt;BaseResponseDTO&lt;AccommodationBooking&gt;&gt; updateBooking(
            @PathVariable String id,
            @RequestBody BookingRequestDTO request) {
        try {
<span class="fc" id="L421">            log.info(&quot;üîÑ PUT /booking/update/{} - Updating booking&quot;, id);</span>
            
<span class="fc" id="L423">            Optional&lt;AccommodationBooking&gt; bookingOpt = bookingService.getBookingById(id);</span>

<span class="fc bfc" id="L425" title="All 2 branches covered.">            if (bookingOpt.isEmpty()) {</span>
<span class="fc" id="L426">                return ResponseEntity.status(HttpStatus.NOT_FOUND)</span>
<span class="fc" id="L427">                        .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L428">                                HttpStatus.NOT_FOUND.value(),</span>
                                &quot;Booking not found&quot;,
                                null
                        ));
            }

<span class="fc" id="L434">            AccommodationBooking booking = bookingOpt.get();</span>
            
            // Only allow update for confirmed bookings (status = 1)
<span class="fc bfc" id="L437" title="All 2 branches covered.">            if (booking.getStatus() != 1) {</span>
<span class="fc" id="L438">                return ResponseEntity.status(HttpStatus.BAD_REQUEST)</span>
<span class="fc" id="L439">                        .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L440">                                HttpStatus.BAD_REQUEST.value(),</span>
                                &quot;Only confirmed bookings can be updated&quot;,
                                null
                        ));
            }

            // Store old total price for refund/extra pay calculation
<span class="fc" id="L447">            int oldTotalPrice = booking.getTotalPrice();</span>
            
            // Get new room
<span class="fc" id="L450">            Optional&lt;Room&gt; newRoomOpt = roomRepository.findById(request.getRoomID());</span>
<span class="fc bfc" id="L451" title="All 2 branches covered.">            if (newRoomOpt.isEmpty()) {</span>
<span class="fc" id="L452">                return ResponseEntity.status(HttpStatus.NOT_FOUND)</span>
<span class="fc" id="L453">                        .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L454">                                HttpStatus.NOT_FOUND.value(),</span>
                                &quot;Room not found&quot;,
                                null
                        ));
            }
            
<span class="fc" id="L460">            Room newRoom = newRoomOpt.get();</span>
            
            // Calculate new total price
<span class="fc" id="L463">            LocalDateTime checkIn = request.getCheckInDate();</span>
<span class="fc" id="L464">            LocalDateTime checkOut = request.getCheckOutDate();</span>
<span class="fc" id="L465">            long days = java.time.Duration.between(checkIn, checkOut).toDays();</span>
            
<span class="fc" id="L467">            int newRoomPrice = newRoom.getRoomType().getPrice();</span>
<span class="fc" id="L468">            int newTotalPrice = newRoomPrice * (int) days;</span>
            
<span class="pc bpc" id="L470" title="1 of 2 branches missed.">            if (request.isBreakfast()) {</span>
<span class="nc" id="L471">                newTotalPrice += 50000 * (int) days;</span>
            }
            
            // Calculate refund or extra pay
<span class="fc" id="L475">            int priceDifference = newTotalPrice - oldTotalPrice;</span>
            
<span class="fc" id="L477">            log.info(&quot;üí∞ Price calculation - Old: {}, New: {}, Difference: {}&quot;, </span>
<span class="fc" id="L478">                    oldTotalPrice, newTotalPrice, priceDifference);</span>
            
            // Update booking fields
<span class="fc" id="L481">            booking.setRoom(newRoom);</span>
<span class="fc" id="L482">            booking.setCheckInDate(checkIn);</span>
<span class="fc" id="L483">            booking.setCheckOutDate(checkOut);</span>
<span class="fc" id="L484">            booking.setCustomerID(request.getCustomerID());</span>
<span class="fc" id="L485">            booking.setCustomerName(request.getCustomerName());</span>
<span class="fc" id="L486">            booking.setCustomerEmail(request.getCustomerEmail());</span>
<span class="fc" id="L487">            booking.setCustomerPhone(request.getCustomerPhone());</span>
<span class="fc" id="L488">            booking.setBreakfast(request.isBreakfast());</span>
<span class="fc" id="L489">            booking.setCapacity(request.getCapacity());</span>
<span class="fc" id="L490">            booking.setTotalPrice(newTotalPrice);</span>
<span class="fc" id="L491">            booking.setExtraPay(priceDifference);</span>
<span class="fc" id="L492">            booking.setUpdatedDate(LocalDateTime.now());</span>
            
            // Update status based on price difference
<span class="fc bfc" id="L495" title="All 2 branches covered.">            if (priceDifference &gt; 0) {</span>
                // Extra payment needed - change to waiting for payment
<span class="fc" id="L497">                booking.setStatus(0);</span>
<span class="fc bfc" id="L498" title="All 2 branches covered.">            } else if (priceDifference &lt; 0) {</span>
                // Refund needed - change to request refund
<span class="fc" id="L500">                booking.setStatus(3);</span>
            }
            // If priceDifference == 0, status remains unchanged (1 = Confirmed)
            
            // Save directly to avoid service recalculation
<span class="fc" id="L505">            AccommodationBooking updatedBooking = bookingRepository.save(booking);</span>
            
<span class="fc" id="L507">            String message = &quot;Booking updated successfully&quot;;</span>
<span class="fc bfc" id="L508" title="All 2 branches covered.">            if (priceDifference &gt; 0) {</span>
<span class="fc" id="L509">                message += &quot; - Extra payment required: Rp &quot; + priceDifference;</span>
<span class="fc bfc" id="L510" title="All 2 branches covered.">            } else if (priceDifference &lt; 0) {</span>
<span class="fc" id="L511">                message += &quot; - Refund amount: Rp &quot; + Math.abs(priceDifference);</span>
            }
            
<span class="fc" id="L514">            log.info(&quot;‚úÖ Booking updated - {}&quot;, message);</span>

<span class="fc" id="L516">            return ResponseEntity.ok(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L517">                    HttpStatus.OK.value(),</span>
                    message,
                    updatedBooking
            ));

<span class="fc" id="L522">        } catch (Exception e) {</span>
<span class="fc" id="L523">            log.error(&quot;‚ùå Error updating booking: {}&quot;, e.getMessage());</span>
<span class="fc" id="L524">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="fc" id="L525">                    .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L526">                            HttpStatus.INTERNAL_SERVER_ERROR.value(),</span>
<span class="fc" id="L527">                            &quot;Error updating booking: &quot; + e.getMessage(),</span>
                            null
                    ));
        }
    }

    // GET count bookings
    @GetMapping(&quot;/count&quot;)
    public ResponseEntity&lt;BaseResponseDTO&lt;Long&gt;&gt; countBookings() {
<span class="fc" id="L536">        long count = bookingService.countAllBookings();</span>
<span class="fc" id="L537">        return ResponseEntity.ok(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L538">                HttpStatus.OK.value(),</span>
                &quot;Success&quot;,
<span class="fc" id="L540">                count</span>
        ));
    }

    // GET booking chart (income by property - shows actual property income from database)
    @GetMapping(&quot;/chart&quot;)
    public ResponseEntity&lt;BaseResponseDTO&lt;?&gt;&gt; getBookingChart(
            @RequestParam(required = false) Integer month,
            @RequestParam(required = false) Integer year) {
        
        try {
<span class="fc" id="L551">            log.info(&quot;üìä GET /booking/chart - month: {}, year: {}&quot;, month, year);</span>
            
            // Get all properties and their current income from database
<span class="fc" id="L554">            List&lt;Property&gt; allProperties = propertyService.getAllProperties();</span>
            
            // Map to store property name -&gt; income
<span class="fc" id="L557">            java.util.Map&lt;String, Integer&gt; propertyIncomeMap = new java.util.LinkedHashMap&lt;&gt;();</span>
            
<span class="fc bfc" id="L559" title="All 2 branches covered.">            for (Property property : allProperties) {</span>
                // Only show properties with income &gt; 0
<span class="fc bfc" id="L561" title="All 2 branches covered.">                if (property.getIncome() &gt; 0) {</span>
<span class="fc" id="L562">                    propertyIncomeMap.put(property.getPropertyName(), property.getIncome());</span>
                }
<span class="fc" id="L564">            }</span>
            
            // Sort by income descending
<span class="fc" id="L567">            var sortedMap = propertyIncomeMap.entrySet().stream()</span>
<span class="pc" id="L568">                .sorted((a, b) -&gt; Integer.compare(b.getValue(), a.getValue()))</span>
<span class="fc" id="L569">                .collect(java.util.stream.Collectors.toMap(</span>
                    java.util.Map.Entry::getKey,
                    java.util.Map.Entry::getValue,
<span class="nc" id="L572">                    (e1, e2) -&gt; e1,</span>
                    java.util.LinkedHashMap::new
                ));
            
<span class="fc" id="L576">            log.info(&quot;‚úÖ Chart data prepared with {} properties&quot;, sortedMap.size());</span>
            
<span class="fc" id="L578">            return ResponseEntity.ok(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L579">                    HttpStatus.OK.value(),</span>
                    &quot;Success&quot;,
                    sortedMap
            ));
            
<span class="fc" id="L584">        } catch (Exception e) {</span>
<span class="fc" id="L585">            log.error(&quot;‚ùå Error getting booking chart: {}&quot;, e.getMessage());</span>
<span class="fc" id="L586">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="fc" id="L587">                    .body(new BaseResponseDTO&lt;&gt;(</span>
<span class="fc" id="L588">                            HttpStatus.INTERNAL_SERVER_ERROR.value(),</span>
<span class="fc" id="L589">                            &quot;Error getting booking chart: &quot; + e.getMessage(),</span>
                            null
                    ));
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>