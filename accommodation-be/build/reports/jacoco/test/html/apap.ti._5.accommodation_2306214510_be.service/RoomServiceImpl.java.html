<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RoomServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">accommodation-2306214510-be</a> &gt; <a href="index.source.html" class="el_package">apap.ti._5.accommodation_2306214510_be.service</a> &gt; <span class="el_source">RoomServiceImpl.java</span></div><h1>RoomServiceImpl.java</h1><pre class="source lang-java linenums">package apap.ti._5.accommodation_2306214510_be.service;

import apap.ti._5.accommodation_2306214510_be.model.Room;
import apap.ti._5.accommodation_2306214510_be.model.RoomType;
import apap.ti._5.accommodation_2306214510_be.repository.AccommodationBookingRepository;
import apap.ti._5.accommodation_2306214510_be.repository.RoomRepository;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

@Service
@Transactional
<span class="fc" id="L18">@Slf4j</span>
public class RoomServiceImpl implements RoomService {

    private final RoomRepository roomRepository;
    private final AccommodationBookingRepository bookingRepository;

    // Constructor Dependency Injection
    public RoomServiceImpl(RoomRepository roomRepository,
<span class="fc" id="L26">                           AccommodationBookingRepository bookingRepository) {</span>
<span class="fc" id="L27">        this.roomRepository = roomRepository;</span>
<span class="fc" id="L28">        this.bookingRepository = bookingRepository;</span>
<span class="fc" id="L29">    }</span>

    @Override
    public Room createRoom(Room room) {
<span class="fc" id="L33">        room.setCreatedDate(LocalDateTime.now());</span>
<span class="fc" id="L34">        room.setUpdatedDate(LocalDateTime.now());</span>
<span class="fc" id="L35">        room.setAvailabilityStatus(1); // Available by default</span>
<span class="fc" id="L36">        room.setActiveRoom(1); // Active by default</span>
<span class="fc" id="L37">        return roomRepository.save(room);</span>
    }

    @Override
    public List&lt;Room&gt; createMultipleRooms(List&lt;Room&gt; rooms) {
<span class="fc" id="L42">        List&lt;Room&gt; savedRooms = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L43" title="All 2 branches covered.">        for (Room room : rooms) {</span>
<span class="fc" id="L44">            room.setCreatedDate(LocalDateTime.now());</span>
<span class="fc" id="L45">            room.setUpdatedDate(LocalDateTime.now());</span>
<span class="fc" id="L46">            room.setAvailabilityStatus(1);</span>
<span class="fc" id="L47">            room.setActiveRoom(1);</span>
<span class="fc" id="L48">            savedRooms.add(roomRepository.save(room));</span>
<span class="fc" id="L49">        }</span>
<span class="fc" id="L50">        return savedRooms;</span>
    }

    @Override
    public List&lt;Room&gt; getAllRooms() {
<span class="fc" id="L55">        return roomRepository.findAll();</span>
    }

    @Override
    public Optional&lt;Room&gt; getRoomById(String id) {
<span class="fc" id="L60">        return roomRepository.findById(id);</span>
    }

    @Override
    public List&lt;Room&gt; getRoomsByRoomType(RoomType roomType) {
<span class="fc" id="L65">        return roomRepository.findByRoomType(roomType);</span>
    }

    @Override
    public List&lt;Room&gt; getRoomsByPropertyId(String propertyId) {
<span class="fc" id="L70">        return roomRepository.findByPropertyID(propertyId);</span>
    }

    @Override
    public List&lt;Room&gt; getAvailableRooms(LocalDateTime checkIn, LocalDateTime checkOut) {
<span class="fc" id="L75">        List&lt;Room&gt; allRooms = roomRepository.findAll();</span>
<span class="fc" id="L76">        List&lt;Room&gt; availableRooms = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L78" title="All 2 branches covered.">        for (Room room : allRooms) {</span>
<span class="pc bpc" id="L79" title="1 of 2 branches missed.">            if (isRoomAvailable(room.getRoomID(), checkIn, checkOut)) {</span>
<span class="fc" id="L80">                availableRooms.add(room);</span>
            }
<span class="fc" id="L82">        }</span>

<span class="fc" id="L84">        return availableRooms;</span>
    }

    @Override
    public long countRoomsByPropertyAndFloor(String propertyId, int floor) {
        // Get all rooms for property
<span class="fc" id="L90">        List&lt;Room&gt; roomsForProperty = roomRepository.findByPropertyID(propertyId);</span>
        
        // Count rooms on this floor
        // A room is on floor X if its room number starts with floor*100
<span class="fc" id="L94">        return roomsForProperty.stream()</span>
<span class="fc" id="L95">                .filter(room -&gt; {</span>
                    try {
                        // Extract floor from room name (which is the room number)
<span class="fc" id="L98">                        int roomNumber = Integer.parseInt(room.getName());</span>
<span class="fc bfc" id="L99" title="All 4 branches covered.">                        return roomNumber &gt;= (floor * 100) &amp;&amp; roomNumber &lt; ((floor + 1) * 100);</span>
<span class="fc" id="L100">                    } catch (NumberFormatException e) {</span>
<span class="fc" id="L101">                        return false;</span>
                    }
                })
<span class="fc" id="L104">                .count();</span>
    }

    @Override
    public Room updateRoom(Room room) {
<span class="fc" id="L109">        room.setUpdatedDate(LocalDateTime.now());</span>
<span class="fc" id="L110">        return roomRepository.save(room);</span>
    }

    @Override
    public Room updateRoomMaintenance(String roomId, LocalDateTime maintenanceStart, LocalDateTime maintenanceEnd) {
<span class="fc" id="L115">        Optional&lt;Room&gt; roomOpt = roomRepository.findById(roomId);</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">        if (roomOpt.isPresent()) {</span>
<span class="fc" id="L117">            Room room = roomOpt.get();</span>
<span class="fc" id="L118">            room.setMaintenanceStart(maintenanceStart);</span>
<span class="fc" id="L119">            room.setMaintenanceEnd(maintenanceEnd);</span>
<span class="fc" id="L120">            room.setAvailabilityStatus(0); // Unavailable during maintenance</span>
<span class="fc" id="L121">            room.setUpdatedDate(LocalDateTime.now());</span>
<span class="fc" id="L122">            return roomRepository.save(room);</span>
        }
<span class="fc" id="L124">        return null;</span>
    }

    @Override
    public String generateRoomId(String propertyId, int unitNumber) {
<span class="fc" id="L129">        return propertyId + &quot;-&quot; + String.format(&quot;%d&quot;, unitNumber);</span>
    }

    @Override
    public boolean isRoomAvailable(String roomId, LocalDateTime checkIn, LocalDateTime checkOut) {
<span class="fc" id="L134">        log.debug(&quot;Checking availability for room: {} from {} to {}&quot;, roomId, checkIn, checkOut);</span>
        
        // Check maintenance schedule
<span class="fc" id="L137">        Optional&lt;Room&gt; roomOpt = roomRepository.findById(roomId);</span>
<span class="fc bfc" id="L138" title="All 2 branches covered.">        if (roomOpt.isEmpty()) {</span>
<span class="fc" id="L139">            log.warn(&quot;Room not found: {}&quot;, roomId);</span>
<span class="fc" id="L140">            return false;</span>
        }

<span class="fc" id="L143">        Room room = roomOpt.get();</span>

        // Check if room is in maintenance during the requested period
<span class="pc bpc" id="L146" title="3 of 4 branches missed.">        if (room.getMaintenanceStart() != null &amp;&amp; room.getMaintenanceEnd() != null) {</span>
<span class="nc bnc" id="L147" title="All 4 branches missed.">            if (checkIn.isBefore(room.getMaintenanceEnd()) &amp;&amp; checkOut.isAfter(room.getMaintenanceStart())) {</span>
<span class="nc" id="L148">                log.info(&quot;Room {} in maintenance: {} to {}&quot;, roomId, room.getMaintenanceStart(), room.getMaintenanceEnd());</span>
<span class="nc" id="L149">                return false;</span>
            }
        }

        // Check for conflicting bookings - try both JPQL and native query
<span class="fc" id="L154">        var conflictingBookings = bookingRepository.findConflictingBookings(roomId, checkIn, checkOut);</span>
<span class="fc" id="L155">        log.debug(&quot;JPQL Conflicting bookings for room {}: {}&quot;, roomId, conflictingBookings.size());</span>
        
        // If JPQL returns empty but we suspect an issue, also try native query
<span class="fc bfc" id="L158" title="All 2 branches covered.">        if (conflictingBookings.isEmpty()) {</span>
<span class="fc" id="L159">            var nativeConflicts = bookingRepository.findConflictingBookingsNative(roomId, checkIn, checkOut);</span>
<span class="fc" id="L160">            log.debug(&quot;Native Conflicting bookings for room {}: {}&quot;, roomId, nativeConflicts.size());</span>
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">            if (!nativeConflicts.isEmpty()) {</span>
<span class="nc" id="L162">                log.info(&quot;Native query found {} conflicts for room {}&quot;, nativeConflicts.size(), roomId);</span>
            }
<span class="fc" id="L164">            return nativeConflicts.isEmpty();</span>
        }
        
<span class="fc" id="L167">        log.info(&quot;Room {} has {} conflicting bookings&quot;, roomId, conflictingBookings.size());</span>
<span class="fc" id="L168">        conflictingBookings.forEach(b -&gt; log.info(&quot;  - Booking: {} Status: {} CheckIn: {} CheckOut: {}&quot;, </span>
<span class="fc" id="L169">            b.getBookingID(), b.getStatus(), b.getCheckInDate(), b.getCheckOutDate()));</span>
        
<span class="fc" id="L171">        return conflictingBookings.isEmpty();</span>
    }

    @Override
    public void updateRoomAvailability(String roomId, int availabilityStatus) {
<span class="nc" id="L176">        Optional&lt;Room&gt; roomOpt = roomRepository.findById(roomId);</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">        if (roomOpt.isPresent()) {</span>
<span class="nc" id="L178">            Room room = roomOpt.get();</span>
<span class="nc" id="L179">            room.setAvailabilityStatus(availabilityStatus);</span>
<span class="nc" id="L180">            room.setUpdatedDate(LocalDateTime.now());</span>
<span class="nc" id="L181">            roomRepository.save(room);</span>
        }
<span class="nc" id="L183">    }</span>

    @Override
    public List&lt;Room&gt; getRoomsInMaintenance() {
<span class="nc" id="L187">        return roomRepository.findRoomsInMaintenance(LocalDateTime.now());</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>