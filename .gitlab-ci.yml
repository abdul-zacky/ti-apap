stages:
  - build
  - docker-push
  - deploy

variables:
  DOCKER_IMAGE_NAME: ${DOCKER_IMAGE_NAME}
  DOCKER_USERNAME: ${DOCKER_USERNAME}
  DOCKER_PASSWORD: ${DOCKER_PASSWORD}
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA

build:
  stage: build
  image: eclipse-temurin:21-jdk
  cache: []
  script:
    - cd accommodation-be
    - echo "=== Building from commit $(git rev-parse HEAD) ==="
    - echo "=== Checking CorsConfig.java for @Value annotation ==="
    - grep -n '@Value("${CORS_ALLOWED_ORIGINS}")' src/main/java/apap/ti/_5/accommodation_2306214510_be/config/CorsConfig.java && echo "@Value found (GOOD)" || (echo "@Value NOT found (BAD)" && exit 1)
    - echo "=== Checking RestControllers for @CrossOrigin ==="
    - grep -r "@CrossOrigin" src/main/java/apap/ti/_5/accommodation_2306214510_be/restcontroller/ && echo "@CrossOrigin found (BAD)" && exit 1 || echo "No @CrossOrigin found (GOOD)"
    - chmod +x ./gradlew
    - ./gradlew clean build -x test
    - cp $(find build/libs -name "*.jar" | head -n 1) app.jar
  artifacts:
    paths:
      - accommodation-be/app.jar
      - accommodation-be/Dockerfile
      - accommodation-be/k8s/deployment.yaml
      - accommodation-be/k8s/service.yaml
      - accommodation-be/k8s/ingress.yaml
    expire_in: 1 hour
  only:
    - main

docker-push:
  stage: docker-push
  image: docker:24
  services:
    - name: docker:24-dind
  dependencies:
    - build
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  script:
    - cd accommodation-be
    - docker build -t $DOCKER_IMAGE_NAME:$IMAGE_TAG -t $DOCKER_IMAGE_NAME:latest .
    - docker push $DOCKER_IMAGE_NAME:$IMAGE_TAG
    - docker push $DOCKER_IMAGE_NAME:latest
  only:
    - main

deploy:
  stage: deploy
  image: alpine:latest
  dependencies:
    - build
  before_script:
    - apk add --no-cache openssh bash
    - mkdir -p ~/.ssh
    - echo "EC2_HOST is $EC2_HOST"
    - echo "EC2_USER is $EC2_USER"
    - printf "%s\n" "$EC2_SSH_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - echo "Attempting to scan SSH keys from $EC2_HOST..."
    - ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts 2>&1 || true
    - echo "SSH known_hosts:"
    - cat ~/.ssh/known_hosts || echo "No known_hosts file"
  script:
    # Generating Kubernetes ConfigMap manifest
    - |
      printf "apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: accommodation-ti-config\ndata:\n  DATABASE_URL_PROD: \"%s\"\n  DATABASE_USERNAME: \"%s\"\n" \
        "$DATABASE_URL_PROD" "$DATABASE_USERNAME" > config.yaml

    # Generating Kubernetes Secret manifest
    - |
      printf "apiVersion: v1\nkind: Secret\nmetadata:\n  name: accommodation-ti-secret\ntype: Opaque\nstringData:\n  DATABASE_PASSWORD: \"%s\"\n  JWT_SECRET_KEY: \"%s\"\n" \
        "$DATABASE_PASSWORD" "$JWT_SECRET_KEY" > secret.yaml

    # Update deployment.yaml with the correct image tag
    - sed "s|\${DOCKER_IMAGE_NAME}:*\${IMAGE_TAG}|$DOCKER_IMAGE_NAME:$IMAGE_TAG|" accommodation-be/k8s/deployment.yaml > deployment.yaml

    # Transfer configuration files to EC2
    - scp -o StrictHostKeyChecking=no config.yaml $EC2_USER@$EC2_HOST:~/app/k8s/accommodation-ti-config.yaml
    - scp -o StrictHostKeyChecking=no secret.yaml $EC2_USER@$EC2_HOST:~/app/k8s/accommodation-ti-secret.yaml
    - scp -o StrictHostKeyChecking=no deployment.yaml $EC2_USER@$EC2_HOST:~/app/k8s/accommodation-ti-deployment.yaml
    - scp -o StrictHostKeyChecking=no accommodation-be/k8s/service.yaml $EC2_USER@$EC2_HOST:~/app/k8s/accommodation-ti-service.yaml
    - scp -o StrictHostKeyChecking=no accommodation-be/k8s/ingress.yaml $EC2_USER@$EC2_HOST:~/app/k8s/accommodation-ti-ingress.yaml

    # Apply Kubernetes manifests on EC2
    - ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "sudo k3s kubectl apply -f ~/app/k8s/accommodation-ti-config.yaml"
    - ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "sudo k3s kubectl apply -f ~/app/k8s/accommodation-ti-secret.yaml"
    - ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "sudo k3s kubectl apply -f ~/app/k8s/accommodation-ti-deployment.yaml"
    - ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "sudo k3s kubectl apply -f ~/app/k8s/accommodation-ti-service.yaml"
    - ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "sudo k3s kubectl apply -f ~/app/k8s/accommodation-ti-ingress.yaml"

    # Force rollout restart to pull new image
    - ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "sudo k3s kubectl rollout restart deployment accommodation-ti"
  only:
    - main
